const state = {
  project: {},
  user: {},
  members: [],
  getStage: 0,
};


const mutations = {
    setProject(state, project) {
      state.project = { ...project };
      state.user = project.user || {};
      state.members = Array.isArray(project.members) ? [...project.members] : [];
      state.getStage = project?.stage?.id || 0;

      // Ensure the project owner (user) is always included in members list without duplicates
      const ownerUuid = state.user?.uuid;
      if (ownerUuid && !state.members.some((member) => member?.uuid === ownerUuid)) {
        state.members.unshift(state.user);
      }
    },
    nameUpdate(state, { name, slug }) {
    state.project = {
      ...state.project,
      name,
      slug,
    };
  },
    aboutUpdate(state,about){
      state.project.about = about
    },
    updateNotes(state,notes){
      state.project.notes = notes
    },
    detachMember(state,memberId){
      const index = state.project.members.findIndex(member => member.uuid === memberId);
      if (index !== -1) {
        state.project.members.splice(index, 1);
      }
    },
    addScore(state,score){
      state.project.score += score       
    },
    reduceScore(state,score){
      state.project.score -= score
    },
    noteScore(state,score){
      state.project.score = score
    },
    updateHealth(state, { score, status, calculated_at }){
      if (typeof score === 'number') {
        state.project.score = score;
      }
      if (typeof status === 'string' && status.length) {
        state.project.health_status = status;
      }
      if (calculated_at) {
        state.project.health_score_calculated_at = calculated_at;
      }
    },
    updateStage(state,data){
    state.project.stage_updated_at = data.stage_updated
    state.project.stage = data.current_stage
    state.project.postponed_reason= data.postponed_reason
    state.getStage=data.getStage
    },

};

const actions = {
  async loadProject({ commit }, slug) {
    try {
      const { data } = await axios.get(`/api/v1/projects/${slug}`);
      commit('setProject', data);
      return data;
    } catch (error) {
      throw error;
    }
  },
};

export default{
  namespaced: true,
  state,
  mutations,
  actions,
}
