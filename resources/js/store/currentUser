import router from '../router.js';
import Vue from 'vue';
import { clearTwoFaState, markTwoFaPending, pushRoute, getErrorMessage } from '../utils/auth.js';

const resetAuthState = (commit, dispatch, { notify = true } = {}) => {
  commit('setUser', {});
  commit('loggedIn', false);
  commit('clearErrors');
  if (notify) {
    dispatch('subscribeUser/userLogout', null, { root: true });
  }
  clearTwoFaState();
};

const state = {
  user: {},
  errors: {},
  loggedIn: false,
  bootstrapped: false,
};

const getters = {};

const actions = {
  finalizeLogin({ commit, dispatch }, { response, vm, toastMsg }) {
    clearTwoFaState();
    commit('setUser', response.data.user);
    commit('loggedIn', true);
    commit('clearErrors');

    dispatch('subscribeUser/userSubscription', null, { root: true });
    if (toastMsg && vm?.$vToastify) vm.$vToastify.success(toastMsg);
    pushRoute(vm, '/home', router);
  },

  handleLoginResponse({ dispatch }, response) {
    if (response.data.status === '2fa_required') {
      markTwoFaPending();
      pushRoute(null, { name: 'TwoFACode' }, router);
      return;
    }
    dispatch('finalizeLogin', { response });
  },

  async loginUser({ commit, dispatch }, user) {
    Vue.prototype.$Progress.start();
    try {
      await axios.get('/sanctum/csrf-cookie');
      const response = await axios.post('/session/login', user);
      dispatch('handleLoginResponse', response);
      Vue.prototype.$Progress.finish();
    } catch (error) {
      Vue.prototype.$Progress.fail();
      const data = error?.response?.data;
      if (data?.errors) {
        commit('setErrors', data.errors);
      } else {
        commit('clearErrors');
        Vue.prototype.$vToastify.error(getErrorMessage(error));
      }
    }
  },

  async twoFactorLogin({ dispatch }, { code, vm }) {
    const response = await axios.post('/twofactor/login-confirm', { code });
    dispatch('finalizeLogin', { response, vm, toastMsg: '2FA successfully verified.' });
  },

  async logoutUser({ commit, dispatch }) {
    try {
      await axios.post('/session/logout');
    } catch (error) {
      Vue.prototype.$vToastify.error(getErrorMessage(error, 'Unable to log out.'));
    } finally {
      resetAuthState(commit, dispatch);
      pushRoute(null, '/login', router);
    }
  },

  deleteUser({ commit, dispatch }) {
    resetAuthState(commit, dispatch);
    router.push('/home');
  },

  updateVerifiedStatus({ commit }, isVerified) {
    commit('setUserVerified', isVerified);
  },

  async bootstrapSession({ commit, dispatch }) {
    try {
      const { data } = await axios.get('/me');

      if (data?.user) {
        commit('setUser', data.user);
        commit('loggedIn', true);
        commit('clearErrors');
        try {
          await dispatch('subscribeUser/userSubscription', null, { root: true });
        } catch (_) {
          // ignore subscription errors during bootstrap
        }
        return data.user;
      }

      resetAuthState(commit, dispatch, { notify: false });
      return null;
    } catch (_) {
      resetAuthState(commit, dispatch, { notify: false });
      return null;
    } finally {
      commit('setBootstrapped', true);
    }
  },
};

const mutations = {
  setErrors(state, data) {
    state.errors = data || {};
  },
  clearErrors(state) {
    state.errors = {};
  },
  setUser(state, data) {
    state.user = data || {};
  },
  loggedIn(state, data) {
    state.loggedIn = data;
  },
  setBootstrapped(state, value) {
    state.bootstrapped = !!value;
  },
  setUserVerified(state, isVerified) {
    if (state.user) {
      state.user.verified = isVerified;
    }
  },
};

export default {
  namespaced: true,
  state,
  getters,
  actions,
  mutations,
};
